<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>DF No Ponto 3.0</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #2563eb;
    --surface: rgba(255, 255, 255, 0.98);
    --text-dark: #1e293b;
    --text-gray: #64748b;
  }

  * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
  body, html, #map { height:100%; width:100%; overflow: hidden; background: #f1f5f9; }

  /* === UI GERAL === */
  .ui-panel {
    position: absolute;
    z-index: 1000;
    background: var(--surface);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 16px;
  }

  /* === PAINEL INFORMATIVO === */
  .info-panel {
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    width: 94%;
    max-width: 400px;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .info-title {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-dark);
  }

  .update-bubble {
    background: #e2e8f0;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-gray);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .info-stats {
    display: flex;
    gap: 15px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-gray);
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .stat-item b { color: var(--text-dark); }

  .dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot.green { background: #22c55e; box-shadow: 0 0 8px #22c55e80;}
  .dot.red { background: #ef4444; }

  /* === BUSCA === */
  .search-wrapper {
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    width: 94%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    padding: 5px;
  }

  .search-input-box { position: relative; width: 100%; }
  
  #search {
    width: 100%;
    height: 40px;
    padding: 0 15px 0 35px;
    border: none;
    background: transparent;
    font-size: 14px;
    outline: none;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
  }

  .suggestions {
    background: #fff;
    border-top: 1px solid #eee;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    border-radius: 0 0 12px 12px;
  }
  .suggestion-item {
    padding: 8px 15px;
    border-bottom: 1px solid #f8fafc;
    cursor: pointer;
    font-size: 13px;
  }
  .suggestion-item:active { background: #f1f5f9; }

  .search-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    padding: 5px;
  }
  .tag {
    background: var(--text-dark);
    color: #fff;
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* === FILTROS === */
  .filtro-container {
    bottom: 30px;
    right: 15px;
    width: 48px;
    height: 48px;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
  }
  .filtro-container.open { width: 200px; height: auto; padding: 15px; bottom: 90px; }
  .filtro-toggle {
    width: 100%; height: 48px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; position: absolute; top: 0; right: 0; z-index: 2; background: var(--surface);
  }
  .filtro-content { margin-top: 40px; opacity: 0; transition: opacity 0.2s; }
  .filtro-container.open .filtro-content { opacity: 1; }
  .filtro-container label {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    font-size: 13px; color: #334155; cursor: pointer; font-weight: 500;
  }
  .filtro-container input { accent-color: var(--primary); transform: scale(1.1); }

  /* === BOTÃO GPS === */
  .btn-gps {
    bottom: 90px; right: 15px; width: 48px; height: 48px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    transition: transform 0.2s;
  }
  .btn-gps svg { width: 24px; height: 24px; fill: #334155; }
  .btn-gps:active { transform: scale(0.9); }

  /* === MARCADORES === */
  .line-label {
    display:inline-block; white-space: nowrap; cursor: pointer; font-weight:700;
    text-align:center; line-height:1.1; padding:2px 5px;
    border:2px solid #1e293b; font-size:12px; border-radius:8px;
    color: #1e293b; box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    background: rgba(255,255,255,0.9);
  }

  /* === POPUP === */
  .leaflet-popup-content-wrapper { border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 0; overflow: hidden; }
  .leaflet-popup-content { margin: 15px; line-height: 1.4; }
  
  /* Popup Customizado do Ônibus */
  .custom-popup { color: var(--text-dark); width: 220px; margin: -15px; }
  .popup-header { text-align: center; font-size: 17px; font-weight: 800; padding: 14px 0 10px 0; letter-spacing: -0.5px; }
  .custom-popup hr { border: 0; border-top: 1px solid #e2e8f0; margin: 0; }
  .popup-body { padding: 12px 16px; font-size: 14px; line-height: 1.5; }
  .popup-row { margin-bottom: 2px; }
  .popup-label { font-weight: 800; color: var(--text-dark); margin-right: 4px; }
  .popup-value { font-weight: 400; color: #334155; }

  /* Cluster */
  .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: rgba(30, 41, 59, 0.4); }
  .marker-cluster div { background-color: #1e293b; color: #fff; font-weight: bold; border-radius: 50%; font-size: 12px; }

</style>
</head>
<body>

<div class="ui-panel info-panel">
  <div class="info-header">
    <div class="info-title">DF No Ponto 3.0</div>
    <div class="update-bubble">
      <div id="status-dot" class="dot green"></div>
      <span id="update-time">Carregando...</span>
    </div>
  </div>
  <div class="info-stats">
    <div class="stat-item"><div class="dot green"></div> <b id="count-online">0</b> Online</div>
    <div class="stat-item"><div class="dot red"></div> <b id="count-offline">0</b> Offline</div>
  </div>
</div>

<div class="ui-panel search-wrapper">
  <div class="search-input-box">
    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    <input type="text" id="search" placeholder="Filtrar linha ou prefixo..." autocomplete="off"/>
  </div>
  <div id="suggestions" class="suggestions"></div>
  <div id="search-tags" class="search-tags"></div>
</div>

<div class="ui-panel filtro-container" id="filtro-panel">
  <div class="filtro-toggle" onclick="toggleFiltro()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2"><path d="M3 6h18M6 12h12M10 18h4"/></svg>
  </div>
  <div class="filtro-content">
    <div style="font-weight:800; margin-bottom:12px; color:var(--primary)">Filtros</div>
    <label><input id="chk-todos" type="checkbox" checked> Todas</label>
    <label><input class="chk-empresa" type="checkbox" value="PIRACICABANA" checked> Piracicabana</label>
    <label><input class="chk-empresa" type="checkbox" value="PIONEIRA" checked> Pioneira</label>
    <label><input class="chk-empresa" type="checkbox" value="URBI" checked> Urbi</label>
    <label><input class="chk-empresa" type="checkbox" value="MARECHAL" checked> Marechal</label>
    <label><input class="chk-empresa" type="checkbox" value="BSBUS" checked> BsBus</label>
  </div>
</div>

<div class="ui-panel btn-gps" onclick="localizarUsuario()" title="Meu Local">
  <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
/* === CONFIGURAÇÕES === */
const BASE_API_URL = "https://corsproxy.io/?https%3A%2F%2Fgeoserver.semob.df.gov.br%2Fgeoserver%2Fsemob%2Fows%3Fservice%3DWFS%26version%3D1.0.0%26request%3DGetFeature%26typeName%3Dsemob%253A%25C3%259Altima%2520posi%25C3%25A7%25C3%25A3o%2520da%2520frota%26outputFormat%3Dapplication%252Fjson";

// Cores Atualizadas
const CORES = {
  "PIRACICABANA": "#449900",
  "PIONEIRA": "#ffd500",
  "URBI": "#0080ff",
  "MARECHAL": "#ff9100",
  "BSBUS": "#4dff00",
  "DESCONHECIDO": "#eeeeee"
};

const map = L.map('map', {zoomControl: false}).setView([-15.7942, -47.8822], 11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(map);

const markers = L.markerClusterGroup({
  chunkedLoading: true, maxClusterRadius: 45, disableClusteringAtZoom: 16, spiderfyOnMaxZoom: true, showCoverageOnHover: false
});
map.addLayer(markers);

// ESTADOS GLOBAIS
let todosDados = [];
let termosBusca = [];
let carregando = false;
let popupAbertoId = null; // Armazena o ID (prefixo) do popup aberto para reabrir
let dadosTracado = null; // Armazena o JSON do traçado
let linhasTracado = []; // Layers das linhas desenhadas

/* === LÓGICA DO TRAÇADO === */
async function carregarTracado() {
  try {
    const res = await fetch('json/tracado_linha.json');
    if (res.ok) dadosTracado = await res.json();
  } catch (err) { console.warn("Erro ao carregar traçados:", err); }
}
carregarTracado(); // Inicia carregamento

function limparTracado() {
    linhasTracado.forEach(l => map.removeLayer(l));
    linhasTracado = [];
}

function desenharTracado(cd_linha, empresa, sentidoApi) {
    if (!dadosTracado || !cd_linha) return;
    limparTracado();

    // Filtra pelo código da linha
    const candidatos = dadosTracado.filter(x => String(x.cd_linha) === String(cd_linha));
    if (!candidatos.length) return;

    // Tenta achar o sentido correto
    let sentidoNome = (sentidoApi === '0' || sentidoApi === 0) ? 'IDA' : 'VOLTA';
    let rota = candidatos.find(c => String(c.sentido_linha).toUpperCase() === sentidoNome);
    
    // Fallbacks
    if (!rota) rota = candidatos.find(c => String(c.sentido_linha).toUpperCase() === 'CIRCULAR');
    if (!rota) rota = candidatos[0];

    try {
        const coords = JSON.parse(rota.tracado_linha);
        const cor = CORES[empresa] || '#000';

        // Linha Branca (Borda)
        const borda = L.polyline(coords, { color: 'white', weight: 6, opacity: 0.9 }).addTo(map);
        // Linha Colorida (Miolo)
        const miolo = L.polyline(coords, { color: cor, weight: 4, opacity: 1 }).addTo(map);

        linhasTracado.push(borda, miolo);

        // Ajusta zoom para ver a rota
        map.fitBounds(miolo.getBounds(), { padding: [50, 50] });

        // Clique na linha limpa ela
        miolo.on('click', limparTracado);

    } catch (e) { console.error("Erro ao desenhar rota", e); }
}

/* === FUNÇÕES UI === */
function toggleFiltro() { document.getElementById('filtro-panel').classList.toggle('open'); }
function localizarUsuario() { map.locate({setView: true, maxZoom: 16}); }

map.on('locationfound', e => {
    L.circleMarker(e.latlng, {radius: 8, color: 'white', fillColor: '#2563eb', fillOpacity: 1})
     .addTo(map).bindPopup("Você está aqui").openPopup();
});

/* === PERSISTÊNCIA DO POPUP === */
// Quando um popup abre, salva o ID (se for de ônibus)
map.on('popupopen', function(e) {
    const marker = e.popup._source;
    if (marker && marker.busData) {
        popupAbertoId = marker.busData.prefixo;
    }
});
// Quando fecha, limpa (opcional, mas bom pra evitar abrir onde não deve)
map.on('popupclose', function(e) {
   const marker = e.popup._source;
    if (marker && marker.busData && popupAbertoId === marker.busData.prefixo) {
        // Delay pequeno para permitir troca de popup sem perder ref
        setTimeout(() => { 
             // Só limpa se nenhum outro abriu nesse meio tempo
             if(map._popup && map._popup._source && map._popup._source.busData.prefixo !== popupAbertoId) {
                 popupAbertoId = null; 
             }
        }, 100);
    }
});

/* === HELPERS DATA === */
function parseDataManual(dataStr) {
    if (!dataStr) return null;
    const p = dataStr.split(' '); if(p.length < 2) return null;
    const d = p[0].split('-'); const h = p[1].split(':');
    return new Date(parseInt(d[0]), parseInt(d[1])-1, parseInt(d[2]), parseInt(h[0]), parseInt(h[1]), parseInt(h[2]));
}
function formatarHora(d) { if(!d) return "--:--:--"; return d.toLocaleTimeString('pt-BR'); }
function formatarDataDia(d) { if(!d) return "--/--/----"; return d.toLocaleDateString('pt-BR'); }
function calcularTempoRelativo(d) {
    if (!d) return "Desconhecido";
    const diff = Math.floor((new Date() - d) / 1000);
    if (diff < 0) return "Agora";
    if (diff < 60) return `${diff}s atrás`;
    const m = Math.floor(diff / 60);
    if (m < 60) return `${m}m ${diff % 60}s atrás`;
    return `${Math.floor(m/60)}h atrás`;
}
function getEmpresa(p) {
    const s = String(p||'');
    if(s.startsWith('1')) return 'PIRACICABANA';
    if(s.startsWith('2')) return 'PIONEIRA';
    if(s.startsWith('3')) return 'URBI';
    if(s.startsWith('4')) return 'MARECHAL';
    if(s.startsWith('5')||s.startsWith('7')) return 'BSBUS';
    return 'DESCONHECIDO';
}
function getSentidoTexto(s) { if(s=='0'||s===0) return 'IDA'; if(s=='1'||s===1) return 'VOLTA'; return '—'; }

function criarPopup(p, empresa) {
    const d = parseDataManual(p.datalocal);
    return `
        <div class="custom-popup">
            <div class="popup-header">Linha: ${p.cd_linha || 'N/A'}</div>
            <hr>
            <div class="popup-body">
                <div class="popup-row"><span class="popup-label">Sentido:</span><span class="popup-value">${getSentidoTexto(p.sentido)}</span></div>
                <div class="popup-row"><span class="popup-label">Prefixo:</span><span class="popup-value">${p.prefixo}</span></div>
                <div class="popup-row"><span class="popup-label">Empresa:</span><span class="popup-value">${empresa}</span></div>
                <div class="popup-row"><span class="popup-label">Data:</span><span class="popup-value">${formatarDataDia(d)}</span></div>
                <div class="popup-row"><span class="popup-label">Horário:</span><span class="popup-value">${formatarHora(d)}</span></div>
                <div class="popup-row"><span class="popup-label">Último sinal:</span><span class="popup-value">${calcularTempoRelativo(d)}</span></div>
            </div>
        </div>
    `;
}

/* === RENDERIZAÇÃO === */
function renderizarMapa() {
    markers.clearLayers();
    
    let online=0, offline=0;
    const agora = new Date();
    const empresasAtivas = Array.from(document.querySelectorAll('.chk-empresa:checked')).map(cb => cb.value);
    let markerReabrir = null;

    const layers = [];

    todosDados.forEach(feature => {
        const p = feature.properties;
        if(!p.latitude || parseFloat(p.latitude) === 0) return;

        const empresa = getEmpresa(p.prefixo);
        if(!empresasAtivas.includes(empresa)) return;

        const d = parseDataManual(p.datalocal);
        if(d && (agora - d)/60000 < 20) online++; else offline++;

        if(termosBusca.length > 0) {
            const txt = (String(p.cd_linha)+" "+String(p.prefixo)).toLowerCase();
            if(!termosBusca.some(t => txt.includes(t.toLowerCase()))) return;
        }

        const cor = CORES[empresa];
        const htmlIcon = `<div class="line-label" style="background-color: ${cor};">${p.cd_linha || p.prefixo}</div>`;
        const icon = L.divIcon({ className: '', html: htmlIcon, iconSize: [40, 20], iconAnchor: [20, 10], popupAnchor: [0, -10] });
        
        const marker = L.marker([p.latitude, p.longitude], { icon: icon });
        
        // Armazena dados no objeto marker para uso posterior (popup persistence)
        marker.busData = p; 

        marker.bindPopup(criarPopup(p, empresa));

        // Evento de Clique para Traçado e Seleção
        marker.on('click', () => {
             popupAbertoId = p.prefixo; // Garante que saiba que este é o ativo
             desenharTracado(p.cd_linha, empresa, p.sentido);
        });

        // Verifica se é o popup que deve estar aberto
        if (popupAbertoId && String(p.prefixo) === String(popupAbertoId)) {
            markerReabrir = marker;
        }

        layers.push(marker);
    });

    document.getElementById('count-online').innerText = online;
    document.getElementById('count-offline').innerText = offline;

    markers.addLayers(layers);

    // Reabre o popup se necessário (com suporte a cluster)
    if (markerReabrir) {
        // Usa setTimeout para garantir que o cluster já processou a adição
        setTimeout(() => {
            markers.zoomToShowLayer(markerReabrir, () => {
                markerReabrir.openPopup();
            });
        }, 100);
    }
}

/* === FETCH === */
async function atualizarDados() {
    if(carregando) return;
    carregando = true;
    try {
        const url = `${BASE_API_URL}&_t=${new Date().getTime()}`;
        const req = await fetch(url);
        const json = await req.json();
        if(json.features) {
            todosDados = json.features;
            renderizarMapa();
            const agora = new Date();
            document.getElementById('update-time').innerText = `Atualizado às ${formatarHora(agora)}`;
            document.getElementById('status-dot').style.backgroundColor = "#22c55e";
        }
    } catch(e) {
        console.error(e);
        document.getElementById('update-time').innerText = "Erro conexão";
        document.getElementById('status-dot').style.backgroundColor = "#ef4444";
    } finally { carregando = false; }
}

/* === EVENTOS UI === */
document.querySelectorAll('.chk-empresa').forEach(c => c.addEventListener('change', renderizarMapa));
document.getElementById('chk-todos').addEventListener('change', e => {
    document.querySelectorAll('.chk-empresa').forEach(c => c.checked = e.target.checked);
    renderizarMapa();
});

const input = document.getElementById('search');
const sugestoes = document.getElementById('suggestions');
const areaTags = document.getElementById('search-tags');

function atualizarTags() {
    areaTags.innerHTML = '';
    termosBusca.forEach(t => {
        const el = document.createElement('div'); el.className = 'tag';
        el.innerHTML = `${t} <span>✕</span>`;
        el.onclick = () => { termosBusca = termosBusca.filter(x => x !== t); atualizarTags(); renderizarMapa(); limparTracado(); };
        areaTags.appendChild(el);
    });
}
input.addEventListener('input', e => {
    const val = e.target.value.trim().toLowerCase();
    if(!val) { sugestoes.style.display='none'; return; }
    const set = new Set();
    todosDados.forEach(f => { if(f.properties.cd_linha) set.add(f.properties.cd_linha); if(f.properties.prefixo) set.add(String(f.properties.prefixo)); });
    const matches = Array.from(set).filter(x => x.toLowerCase().includes(val)).slice(0, 8);
    sugestoes.innerHTML = matches.map(m => `<div class="suggestion-item">${m}</div>`).join('');
    sugestoes.style.display = matches.length ? 'block' : 'none';
});
sugestoes.addEventListener('click', e => {
    if(e.target.classList.contains('suggestion-item')) {
        const v = e.target.innerText;
        if(!termosBusca.includes(v)) { termosBusca.push(v); atualizarTags(); renderizarMapa(); }
        input.value=''; sugestoes.style.display='none';
    }
});

atualizarDados();
setInterval(atualizarDados, 5000);
</script>
</body>
</html>
